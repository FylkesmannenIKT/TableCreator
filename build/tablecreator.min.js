/*! tablecreator 2017-12-07 */
function TableCreator(a,b){"use strict";return this instanceof TableCreator?(this.ctx=this,this.data=a,this.el=b,this.el.onkeyup=function(a){return 13!==a.which&&13!==a.keyCode||a.path[0].click(),console.log(a),!0},this.settings={schemaId:null,instanceId:null,precision:2,isResizable:!1,createUrl:null,saveUrl:null,deleteUrl:null},this.activateCallbacks=[],this.addActivateCallback=function(a){this.activateCallbacks.push(a)},this.build=function(){return this.buildTable(this.data,this.el),this},this.setCreateUrl=function(a){return this.settings.createUrl=a,this},this.setSaveUrl=function(a){return this.settings.saveUrl=a,this},this.setDeleteUrl=function(a){return this.settings.deleteUrl=a,this},this.getTableDefinitionInfo=function(){return this.data&&this.data.table},this.getTableDefinitionColumns=function(){return this.data&&this.data.thead&&this.data.thead.cols},this.init=function(){return this.data.hasOwnProperty("table")&&(this.data.table.hasOwnProperty("schemaId")&&(this.settings.schemaId=this.data.table.schemaId),this.data.table.hasOwnProperty("instanceId")&&(this.settings.instanceId=this.data.table.instanceId),this.data.table.hasOwnProperty("settings")&&this.data.table.settings.hasOwnProperty("isResizable")&&(this.settings.isResizable=this.data.table.settings.isResizable)),this},this.init(),this.activate=function(){if(null===this.settings.createUrl&&console.warn("Url to create row is not set."),null===this.settings.saveUrl&&console.warn("Url to save changes is not set."),null===this.settings.deleteUrl&&console.warn("Url to delete rows is not set."),$(".tcActionRow").removeClass("hide"),0===$("#EditModal").length&&this.createModal("Edit","Endring","Lukk","Lagre"),this.addEditLinks(),0===$("#UndoModal").length&&this.createModal("Undo","Angre","Lukk","Utf√∏r"),this.addUndoLinks(),0===$("#DeleteModal").length&&this.createModal("Delete","Sletting","Avbryt","Slett"),this.addDeleteLinks(),this.settings.isResizable){var a=this,b=$('<a class="tcActionRow add" tabindex="0">Legg til ny rad</a>'),c=$(this.el).find(".tcActionMenu");c.append(b),b.on("click",function(){a.newAction()})}return 0===$("#CommentModal").length&&this.createModal("Comment","Kommentar","Avbryt","Lagre"),this.addCommentLink(),this.activateCallbacks.forEach(this.callCallback),this},this.buildTable=function(a,b){var c="",d="",e=!1;a.hasOwnProperty("table")&&(a.table.hasOwnProperty("title")&&"string"==typeof a.table.title&&(d=a.table.title),a.table.hasOwnProperty("settings")&&(a.table.settings.hasOwnProperty("decimals")&&"number"==typeof a.table.settings.decimals&&(this.settings.precision=a.table.settings.decimals),e=a.table.settings.hasOwnProperty("dataOrientation")&&"vertical"===a.table.settings.dataOrientation,c+=e?" vertical":" horizontal"),c+=a.table.hasOwnProperty("class")?a.table["class"]:"");var f="";""!==d&&(f+='<p class="tc_heading">'+d+"</p>"),f+='<table class="tc_table '+c+'">',f+=e?this.printVerticalTableContent(a):this.printHorizontalTableContent(a),f+="</table>",f+='<div class="tcActionMenu"></div>',f+='<div class="tcComment"><span class="comment"></span></div>',b.innerHTML=f;var g=b.getElementsByClassName("tc_table")[0],h=g.parentNode.offsetWidth,i=g.offsetWidth,j=b.getElementsByClassName("tcComment")[0];j.setAttribute("style","width:"+i/h*100+"%"),a.hasOwnProperty("table")&&a.table.hasOwnProperty("comment")&&"string"==typeof a.table.comment&&(j.querySelector(".comment").innerHTML=a.table.comment)},this.printHorizontalTableContent=function(a){for(var b="<thead>",c=0;c<a.thead.rows.length;++c){var d=a.thead.rows[c];b+="<tr>";for(var e=0;e<d.length;++e){var f=d[e],g=f.hasOwnProperty("colspan")?' colspan="'+f.colspan+'"':"",h=f.hasOwnProperty("title")?f.title:"",i=f.hasOwnProperty("class")?" "+f["class"]:"";b+='<th class="tcTableHeaders'+i+'"'+g+">"+h+"</th>"}b+="</tr>"}b+="<tr>";for(var j=0;j<a.thead.cols.length;++j){var k=a.thead.cols[j],l=k.hasOwnProperty("title")?k.title:"",m=k.hasOwnProperty("class")?k["class"]:"";m+="number"===k.type?" number":"",m+="string"===k.type?" tcLeftAlign":"",m+="multichoice"===k.type?" tcLeftAlign":"",m+=k.hasOwnProperty("type")?"":" tcLeftAlign",b+='<th class="'+m+'">'+l+"</th>"}b+="</tr>",b+="</thead><tbody>";for(var n=0;n<a.tbody.length;++n){var o=a.tbody[n];b+="<tr>";for(var p=a.thead.cols,q=0;q<p.length;++q){var r=p[q].id,s=o.hasOwnProperty(r)?o[r]:"",t=p[q].hasOwnProperty("class")?p[q]["class"]:"";if(p[q].hasOwnProperty("method")){var u=p[q].method,v=p[q].hasOwnProperty("type")?p[q].type:"",w=this.parseMethod(u,o);w="number"===v?this.formatData(w,"number"):"percent"===v?this.formatData(w,"percent"):w,b+='<td class="'+v+" "+t+'">'+w+"</td>"}else b+=this.printCell(p[q].type,t,s,p[q],o,n)}b+="</tr>"}if(b+="</tbody>",a.tfoot.hasOwnProperty("cols")&&Array.isArray(a.tfoot.cols)&&a.tfoot.cols.length>0){b+="<tfoot><tr>";for(var x=0;x<a.tfoot.cols.length;++x){var y,z=a.tfoot.cols[x],A="";x<a.thead.cols.length&&(A=a.thead.cols[x].hasOwnProperty("class")?a.thead.cols[x]["class"]:"");var B=z.hasOwnProperty("class")?z["class"]:"";z.hasOwnProperty("title")?b+='<td class="'+A+" "+B+' string">'+z.title+"</td>":z.hasOwnProperty("method")?(y=this.parseMethod(z.method,a),b+='<td class="'+A+" "+B+' number">'+this.formatData(y,"number")+"</td>"):b+='<td class="'+A+'"></td>'}b+="</tfoot></tr>"}return b},this.printVerticalTableContent=function(a){for(var b="",c=a.thead.rows||[],d=[],e=[],f=0;f<a.thead.cols.length;++f){b+="<tr>";for(var g,h,i,j,k,l,m,n,o,p,q,r=0;r<c.length;++r)o=d[r]||0,p=e[r]||0,i=c[r][o],p>0?--e[r]:(q=i.hasOwnProperty("colspan")?' rowspan="'+i.colspan+'"':"",g=i.hasOwnProperty("title")?i.title:"",h=i.hasOwnProperty("class")?" "+i["class"]:"",b+='<th class="tcTableHeaders'+h+'"'+q+">"+g+"</th>",d[r]=d[r]+1||1,e[r]=i.colspan-1||0);i=a.thead.cols[f],g=i.hasOwnProperty("title")?i.title:"",h=i.hasOwnProperty("class")?" "+i["class"]:"",l=i.hasOwnProperty("type")?i.type:"string",b+='<th class="'+h+' tcLeftAlign">'+g+"</th>",k=i.id,n=i.hasOwnProperty("method");for(var s,t,u=0;u<a.tbody.length;++u)j=a.tbody[u],m=j.hasOwnProperty(k)?j[k]:"",n?(s=i.method,t=this.parseMethod(s,j),t="number"===l?this.formatData(t,"number"):"percent"===l?this.formatData(t,"percent"):t,b+='<td class="'+l+" "+h+'">'+t+"</td>"):b+=this.printCell(l,h,m,i,j,u);if(a.hasOwnProperty("tfoot")&&a.tfoot.hasOwnProperty("cols")&&Array.isArray(a.tfoot.cols)&&a.tfoot.cols.length>0)if(f<a.tfoot.cols.length){var v=a.tfoot.cols[f],w=v.hasOwnProperty("class")?" "+v["class"]:"",x=h+w;v.hasOwnProperty("title")?b+='<td class="'+x+' string">'+v.title+"</td>":v.hasOwnProperty("method")?(m=this.parseMethod(v.method,a),b+='<td class="'+x+' number">'+this.formatData(m,"number")+"</td>"):b+='<td class="'+x+'"></td>'}else b+='<td class="'+h+'"></td>';b+="</tr>"}return b},this.printCell=function(a,b,c,d,e,f){var g="";switch(a){case"method":c=this.parseMethod(c,e),g+='<td class="'+a+" "+b+'">'+this.formatData(c,"number")+"</td>";break;case"number":g+='<td class="'+a+" "+b+'">'+this.formatData(c,"number")+"</td>";break;case"percent":g+='<td class="'+a+" "+b+'">'+this.formatData(c,"percent")+"</td>";break;default:case"string":case void 0:null!==c&&void 0!==c||(c=""),g+='<td class="tcLeftAlign '+a+" "+b+'">'+c+"</td>";break;case"index":g+="<td>"+(f+1)+"</td>";break;case"multichoice":c.constructor===Array&&(c=c.join(", ")),g+='<td class="tcLeftAlign '+a+" "+b+'">'+c+"</td>";break;case"actionArray":g+='<td class="tcActionRow hide '+b+'">';var h=!!e.hasOwnProperty("isSaving")&&e.isSaving;h===!0&&(g+='<i class="fa fa-refresh fa-spin"></i>');var i=d.hasOwnProperty("actions")?d.actions:null;if(null!==i&&i.constructor===Array)for(var j=0;j<i.length;++j)switch(i[j]){case"undo":e.hasOwnProperty("undo")&&null!==e.undo&&(g+='<a title="Angre" class="tcAction undo" data-tc_action="undo" data-tc_row="'+f+'" tabindex="0">angre</a>');break;case"edit":g+='<a title="Rediger" class="tcAction edit" data-tc_action="edit" data-tc_row="'+f+'" tabindex="0">rediger</a>';break;case"delete":this.settings.isResizable&&(g+='<a title="Slett" class="tcAction delete" data-tc_action="delete" data-tc_row="'+f+'" tabindex="0">slett</a>')}g+="</td>"}return g},this.formatData=function(a,b){var c=a,d=2;switch("number"==typeof this.settings.precision&&(d=this.settings.precision),b){case"number":c=parseFloat(c).toFixed(d),c=isNaN(c)?"":c;var e=c.toString().split(".");e[0]=e[0].replace(/\B(?=(\d{3})+(?!\d))/g," "),c=e.join(".");var f='<span class="minus">'+c.replace("-","- ")+"</span>";c="-"===c.charAt(0)?f:c;break;case"percent":c=parseFloat(c).toFixed(d),c=isNaN(c)?"":c+" %";var g='<span class="minus">'+c.replace("-","- ")+"</span>";c="-"===c.charAt(0)?g:c}return c},this.methods={sum:function(a){for(var b=0,c=0;c<a.length;++c)b+=!a[c]||/^\s*$/.test(a[c])?0:parseFloat(a[c]);return b},avg:function(a){for(var b=0,c=0;c<a.length;++c)b+=!a[c]||/^\s*$/.test(a[c])?0:parseFloat(a[c]);return b/a.length},div:function(a){if(0===a.length)return NaN;if(1===a.length)return a[0];for(var b=parseFloat(a[0]),c=1;c<a.length;++c)b/=!a[c]||/^\s*$/.test(a[c])?1:a[c];return b},mult:function(a){if(a.length<1)return NaN;for(var b=a[0],c=1;c<a.length;++c)b*=!a[c]||/^\s*$/.test(a[c])?1:a[c];return b}},this.calculate=function(a,b,c){var d,e=[];if(c.hasOwnProperty("tbody"))for(var f=c.thead.cols,g=c.tbody,h=0;h<b.length;++h){var i=b[h];if("number"!=typeof i){var j=!1;"string"==typeof i&&"-"===i.charAt(0)&&(j=!0,i=i.slice(1));for(var k=null,l=0;l<f.length;++l)if(f[l].id===i){k=f[l];break}if(null!==k&&k.hasOwnProperty("method")){var m=this.parseMethod(k.method,c);e.push(j?-m:m)}else for(var n=0;n<g.length;++n){var o=g[n];if(o.hasOwnProperty(i))if("method"===k.type){var p=this.parseMethod(o[i],o);e.push(j?-p:p)}else"number"===k.type&&e.push(j?-o[i]:o[i])}}else e.push(i)}else for(var q=0;q<b.length;++q){var r=b[q];if("number"==typeof r)e.push(r);else if(c.hasOwnProperty(r))e.push(c[r]);else if("-"===r.charAt(0)&&c.hasOwnProperty(r.slice(1)))e.push(-parseFloat(c[r.slice(1)]));else for(var s=r.slice(1),t=this.data.thead.cols,u=0;u<t.length;++u)if(t[u].id===r||t[u].id===s)if(t[u].hasOwnProperty("method")){var v=this.parseMethod(t[u].method,c);v=t[u].id===s?-v:v,e.push(v)}else e.push(0)}return d=this.methods[a](e)},this.parseMethod=function(a,b){var c=a.replace(/\s+/g,"");c=c.split(/([\,\(\)])/).clean();for(var d=[[]],e=[],f=0;f<c.length;++f){var g=c[f];if(this.methods.hasOwnProperty(g))e.push(g);else if("("===g)d.push([]);else if(g.isNumeric())d[d.length-1].push(parseFloat(g));else if(")"===g){var h=e.pop(),i=d.pop(),j=this.calculate(h,i,b);d[d.length-1].push(j)}else","!==g&&d[d.length-1].push(g)}var k=2;"number"==typeof this.settings.precision&&(k=this.settings.precision);var l=parseFloat(d.pop()).toFixed(k);return l=isNaN(l)?"":l},this.insertRow=function(a,b,c){var d=this.getTableColumnIds(),e=this.constructRowFromData(a,d);if("number"==typeof b){var f="boolean"==typeof c&&c?1:0;this.data.tbody.splice(b,f,e)}else this.data.tbody.push(e)},this.constructRowFromData=function(a,b){var c={};return b.forEach(function(b){void 0!==a[b]&&(c[b]=a[b])}),c},this.getTableColumnIds=function(){var a=[];return this.data.thead.cols.forEach(function(b){b.id&&a.push(b.id)}),a},this.getTableColumnAttribute=function(a,b){var c=[];return this.data.thead.cols.forEach(function(d){if(d[a]){var e={id:d.id};e[a]=d[a],c.push(e)}!d[a]&&d.id&&b&&c.push({id:d.id})}),c},this.createModal=function(a,b,c,d){var e=$('<div class="modal-header">'),f=$('<div class="modal-body">'),g=$('<div class="modal-footer">'),h=$('<button type="button" class="btn btn-primary" id="'+a+'Save">'+d+"</button>");e.append($('<button type="button" class="close" data-dismiss="modal" aria-label="Lukk"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">'+b+"</h4>")),g.append($('<button type="button" class="btn btn-default" data-dismiss="modal">'+c+"</button>")),g.append(h);var i=$('<div id="'+a+'Modal" class="modal face" role="dialog">').append($('<div class="modal-dialog">').append($('<div class="modal-content">').append(e).append(f).append(g)));$("body").append(i),i.on("keyup",function(a){return 13!==a.which&&13!==a.keyCode||h.click(),!0})},this.displayErrorHelper=function(a){if(a=a?a.constructor===String?[a]:a.constructor===Array?a:null:null){var b=$('<div class="panel panel-danger">');b.append('<div class="panel-heading">Feil</div>');var c=$('<div class="panel-body"></div>');b.append(c);for(var d=0;d<a.length;++d){var e=$("<p>");e.html(a[d]),c.append(e)}return b}return""},this.addEditLinks=function(){function a(a){var c=a.target.getAttribute("data-tc_row");b.spawnEditModal(c)}var b=this,c=$(this.el).find(".tcAction.edit");c.on("click",a)},this.spawnEditModal=function(a,b){function c(){return d.saveEditAction(f,a)}var d=this,e=$("#EditModal"),f=e.find(".modal-body");f.data("rowIdx",a),f.html(this.editFor(a)),b&&f.prepend(this.displayErrorHelper(b));var g=e.find("#EditSave");g.off("click").on("click",c),e.modal("show"),f.find(".form-control").first().focus().select()},this.editFor=function(a){for(var b=this.data.tbody[a],c=this.data.thead.cols,d=this.data.table,e="",f=0;f<c.length;++f){var g=c[f].id,h=c[f].title,i=c[f].type,j=null,k=!!c[f].hasOwnProperty("method"),l=!!c[f].hasOwnProperty("editable")&&c[f].editable;if(!k&&"method"!==i&&"actionArray"!==i&&l){switch(e+='<div class="form-group row">',"number"===i||"percent"===i?(e+='<label for="tcEdit_'+g+'" class="control-label col-md-7">'+h+"</label>",e+='<div class="col-md-5">'):(e+='<label for="tcEdit_'+g+'" class="control-label col-md-4">'+h+"</label>",e+='<div class="col-md-8">'),d.hasOwnProperty("pool")&&d.pool.hasOwnProperty(g)&&d.pool[g].constructor===Array&&("multichoice"!==i&&(i="dropdown"),j=d.pool[g]),b[g]=b[g]||"",i){default:case"undefined":case"string":e+='<input type="text" class="form-control" name="tcEdit_'+g+'" value="'+(b[g]||"")+'"/>';break;case"number":var m=Math.pow(10,d.settings.decimals);e+='<input type="number" class="form-control" step="'+(m?1/m:1)+'" name="tcEdit_'+g+'" value="'+b[g]+'" lang="nb"/>';break;case"percent":e+='<input type="number" class="form-control" step="0.1" name="tcEdit_'+g+'" value="'+b[g]+'" lang="nb"/>';break;case"dropdown":e+='<select class="form-control" name="tcEdit_'+g+'">';for(var n=0;n<j.length;++n){var o=this.decodeHtmlEntities(b[g])===j[n]?' selected="selected"':"";e+="<option"+o+">"+j[n]+"</option>"}e+="</select>";break;case"multichoice":for(var p,q,r,s=0;s<j.length;++s){if(p=!1,b[g].constructor===Array)for(var t=0;t<b[g].length&&!p;++t)this.decodeHtmlEntities(b[g][t])===j[s]&&(p=!0);else"string"==typeof b[g]&&b[g]===this.decodeHtmlEntities(j[s])&&(p=!0);q=p?"active":"",r=p?" checked":"",e+='<div class="checkbox"><label class="'+q+'"><input type="checkbox"'+r+' name="tcEdit_'+g+"_"+s+'">'+j[s]+"</label></div>"}}e+="</div></div>"}}return e},this.saveEditAction=function(a,b){function c(a){r.isSaving=!1,e.build().activate();var b=$("#EditModal"),c=$("#EditModal .errorDiv");switch(0===c.length&&(c=$('<div class="errorDiv alert alert-danger"></div>'),b.find(".modal-body").prepend(c)),a.status){case 404:c.html("<p>Ikke lagret:</p><li>Finner ikke lagringsplass (feil 404).</li>");break;default:c.html("<p>Lagring ikke mulig (feil "+a.status+"). √Ö laste siden p√• nytt vil kunne hjelpe (trykk F5 p√• tastaturet).</p>")}b.modal("show")}function d(a){if(r.isSaving=!1,a.Success===!1)return e.setModalError("#EditModal",a.Message,a.Errors),void e.build().activate();for(var c in A)A.hasOwnProperty(c)&&(e.data.tbody[b][c]=A[c]);e.data.tbody[b].undo=x,e.build().activate(),$("#EditModal").modal("hide")}var e=this,f=[],g=!0,h=a.find("input[name^='tcEdit_']");if(h.each(function(){var a=$(this);$(this).callProp("checkValidity")===!1?(g=!1,a.addClass("tc_warning")):a.removeClass("tc_warning")}),g!==!1){var i,j,k,l,m=!1,n=a.find("input[name^='tcEdit_']");n.each(function(a,b){i=$(b),j=i.attr("name").slice("tcEdit_".length),l=i.attr("type"),k=i.val(),"checkbox"===l?(k=i.prop("checked"),m=!0):"number"===l?k=0===i.val().lenght?"0":null===k?"0":""===k?"0":k:0===i.val().length&&(k=""),f.push({key:j,value:k,type:l})});var o=a.find("select[name^='tcEdit_']");o.each(function(a,b){i=$(b),j=i.attr("name").slice("tcEdit_".length),k=i.val(),f.push({key:j,value:k})});var p=null;m&&(p=this.data&&this.data.table&&this.data.table.pool?this.data.table.pool:null);for(var q,r=this.data.tbody[b],s={},t={},u=!0,v=0;v<f.length;++v){if(j=f[v].key,k=f[v].value,l=f[v].hasOwnProperty("type")?f[v].type:null,"number"===l){if("string"==typeof k&&(k=k.replace(/\s/g,""),k=k.replace(/,/g,".")),k=parseFloat(k),r.hasOwnProperty(j)&&(r[j]=parseFloat(r[j])),isNaN(k)){var w=a.find("[name^='tcEdit_"+j+"']");w.addClass("tc_warning"),u=!1;continue}k=k.toString()}"checkbox"!==l?r.hasOwnProperty(j)?r[j]!==k&&(s[j]=r[j],t[j]=k):(s[j]=null,t[j]=k):(q=j.substring(j.lastIndexOf("_")+1,j.length),j=j.substring(0,j.lastIndexOf("_")),t.hasOwnProperty(j)&&t[j].constructor===Array||(s[j]=r[j]||null,t[j]=[]),k===!0&&(k=this.data.table.pool[j][q],t[j].push(k)))}if(!u)return void this.spawnEditModal(b,["Et innskrevet tall ble ikke godkjent. Pr√∏v igjen."]);if($.isEmptyObject(s))return console.log("Ingen endringer"),void $("#EditModal").modal("hide");r.isSaving=!0,this.build().activate(),r.hasOwnProperty("undo")||(r.undo=null);var x={undo:r.undo};for(var y in s)if(s.hasOwnProperty(y))if(s[y]&&s[y].constructor===Array){x[y]=x[y]||[];for(var z=0;z<s[y].length;++z)x[y][z]=this.decodeHtmlEntities(s[y][z])}else x[y]=this.decodeHtmlEntities(s[y]);var A={};for(var B in t)if(t.hasOwnProperty(B))if(t[B].constructor===Array){A[B]=A[B]||[];for(var C=0;C<t[B].length;++C)A[B][C]=this.decodeHtmlEntities(t[B][C])}else A[B]=this.decodeHtmlEntities(t[B]);var D={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,RowId:b,Data:JSON.stringify(A)};$.ajax({type:"POST",url:this.settings.saveUrl,dataType:"json",data:D,success:d,error:c})}},this.setModalError=function(a,b,c){var d=$(a),e=d.find(".errorDiv");if(0===e.length&&(e=$('<div class="errorDiv alert alert-danger"></div>'),d.find(".modal-body").prepend(e)),b&&e.html("<p>"+b+"</p>"),c&&c.constructor===Array)for(var f=0;f<c.length;++f)e.append($("<li>"+c[f]+"</li>"))},this.removeLastUndo=function(a){var b=this.data.tbody[a];if(b.hasOwnProperty("undo")&&null!==b.undo){var c=b.undo,d=b.undo.undo;for(var e in c)c.hasOwnProperty(e)&&"undo"!==e&&(b.property=c.property);b.undo=d}},this.addUndoLinks=function(){function a(a){var c=a.target.getAttribute("data-tc_row");b.spawnUndoModal(c)}var b=this,c=$(this.el).find(".tcAction.undo");c.on("click",a)},this.spawnUndoModal=function(a,b){function c(){d.undoEditAction(a)}var d=this,e=$("#UndoModal"),f=e.find(".modal-body");f.html("<p>Angre og g√• eit steg tilbake?</p>"),b&&f.prepend(this.displayErrorHelper(b));var g=e.find("#UndoSave");g.off("click").on("click",c),e.modal("show"),g.focus().select()},this.undoEditAction=function(a){function b(a){d.isSaving=!1,e.build().activate();var b=$("#UndoModal"),c=$("#UndoModal .errorDiv");switch(0===c.length&&(c=$('<div class="errorDiv alert alert-danger"></div>'),b.find(".modal-body").prepend(c)),a.status){case 404:c.html("<p>Fikk ikke angret:</p><li>Finner ikke lagringsplass (feil 404).</li>");break;default:c.html("<p>Angring ikke mulig (feil "+a.status+").</p>")}}function c(b){if(b.Success===!1)return e.setModalError("#UndoModal",b.Message,b.Errors),e.removeLastUndo(a),d.isSaving=!1,void e.build().activate();for(var c in f)f.hasOwnProperty(c)&&(d[c]=f[c]);e.removeLastUndo(a),d.isSaving=!1,e.build().activate(),$("#UndoModal").modal("hide")}var d=this.data.tbody[a];if(d.undo){d.isSaving=!0,this.build().activate();var e=this,f={};for(var g in d)d.hasOwnProperty(g)&&"undo"!==g&&(f[g]=d[g]);for(var h in d.undo)d.undo.hasOwnProperty(h)&&"undo"!==h&&null!==d.undo[h]&&(f[h]=d.undo[h]);var i={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,RowId:a,Data:JSON.stringify(f)};$.ajax({type:"POST",url:this.settings.saveUrl,dataType:"json",data:i,success:c,error:b})}},this.newAction=function(){function a(){b.constructRow(c)}var b=this,c=$("#EditModal"),d=c.find(".modal-body");d.html(this.blankRowEditor());var e=c.find("#EditSave");e.off("click").on("click",a),c.modal("show")},this.constructRow=function(a){function b(a){var b=$("#EditModal"),c=b.find(".errorDiv");switch(0===c.length&&(c=$('<div class="errorDiv alert alert-danger"></div>'),b.find(".modal-body").prepend(c)),a.status){case 404:c.html("<p><b>Ikke lagret:</b> Finner ikke lagringsplass (feil 404).</p>");break;default:c.html("<p><b>Ikke lagret:</b> Lagring ikke mulig (feil "+a.status+").</p>")}n.find("i.fa-spin").fadeOut(1e3,function(){$(this).remove()}),n.find("i.fa-save").fadeOut(1e3,function(){$(this).remove()})}function c(b){if(b.Success!==!0){var c=b.Errors&&b.Errors.constructor===Array?b.Errors:null;return h.setModalError("#EditModal",b.Message,c),n.find("i.fa-spin").fadeOut(500,function(){$(this).remove()}),void n.find("i.fa-save").fadeOut(1e3,function(){$(this).remove()})}h.data.tbody.push(j),h.build().activate(),a.modal("hide"),n.find("i.fa").remove()}console.log(a);var d,e,f,g,h=this,i=!0,j=this.data.table.template.addTpl||{},k=this.data.table.pool||{},l=a.find("[name^='tcEdit_']");if(l.each(function(){if(d=$(this),console.log("elem:"),console.log(d),d.callProp("checkValidity")===!1?(i=!1,d.addClass("tc_warning")):(d.removeClass("tc_warning"),e=d.attr("name").slice("tcEdit_".length),f=d.val(),d.is("input:checkbox")?d.is(":checked")&&(g=e.substring(e.lastIndexOf("_")+1,e.length),e=e.substring(0,e.lastIndexOf("_")),f=k[e][g]||"",j.hasOwnProperty(e)&&j[e].constructor===Array||(j[e]=[]),j[e].push(f)):d.is("input[type='number']")?j[e]=""===f?"0":null===f?"0":0===f.length?"0":f:j[e]=f),d.is("select")){var a=!h.data.table.pool.hasOwnProperty(e),b=!a&&-1===$.inArray(f,h.data.table.pool[e]);(a||b)&&(i=!1,d.addClass("tc_warning"))}}),i===!1)return void console.log("validity failed");if(null!==this.settings.createUrl){var m={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,Data:JSON.stringify(j)},n=a.find(".modal-footer");n.prepend($('<i class="fa fa-save fa-lg" style="margin-right: 1em;"></i>')),n.prepend($('<i class="fa fa-refresh fa-spin" style="margin-right: 1em;"></i>')),$.ajax({type:"POST",url:this.settings.createUrl,dataType:"json",data:m,success:c,error:b})}},this.blankRowEditor=function(){var a=this.data.thead.cols,b=this.data.table||{},c="",d=null;b.hasOwnProperty("template")&&b.template.hasOwnProperty("addTpl")&&(d=b.template.addTpl);for(var e=0;e<a.length;++e){var f=a[e].id,g=a[e].title,h=a[e].type,i=null,j=!!a[e].hasOwnProperty("method"),k=!!a[e].hasOwnProperty("editable")&&a[e].editable,l=null!==d&&d.hasOwnProperty(f)?d[f]:null;if(!j&&"method"!==h&&"actionArray"!==h&&k){switch(c+='<div class="form-group row">',c+='<label for="tcEdit_'+f+'" class="control-label col-md-4">'+g+"</label>",c+="number"===h?'<div class="col-md-push-3 col-md-5">':'<div class="col-md-8">',b.hasOwnProperty("pool")&&b.pool.hasOwnProperty(f)&&b.pool[f].constructor===Array&&("multichoice"!==h&&(h="dropdown"),i=b.pool[f]),h){default:case"undefined":case"string":c+='<input type="text" class="form-control" name="tcEdit_'+f+'" '+(null===l?"":'value="'+l+'"')+"/>";break;case"number":var m=Math.pow(10,b.settings.decimals);c+='<input type="number" class="form-control" step="'+(m?1/m:1)+'" name="tcEdit_'+f+'" '+(null===l?'value="0"':'value="'+l+'"')+' lang="nb"/>';break;case"percent":c+='<input type="number" class="form-control" step="0.1" name="tcEdit_'+f+'"'+(null===l?'value="0"':'value="'+l+'"')+' lang="nb"/>';break;case"dropdown":c+='<select class="form-control" name="tcEdit_'+f+'">';var n=null!==l?" selected":"";c+="<option"+n+" disabled>Velg en...</option>";for(var o=0;o<i.length;++o)n=l===i[o]?" selected":"",c+="<option"+n+">"+i[o]+"</option>";c+="</select>";break;case"multichoice":for(var p=0;p<i.length;++p)c+='<div class="checkbox"><label><input type="checkbox" name="tcEdit_'+f+"_"+p+'">'+i[p]+"</label></div>"}c+="</div></div>"}}return c},this.addDeleteLinks=function(){function a(a){var c=a.target.getAttribute("data-tc_row");b.spawnDeleteModal(c)}var b=this,c=$(this.el).find(".tcAction.delete");c.on("click",a)},this.spawnDeleteModal=function(a,b){function c(){return d.saveDeleteAction(e,a)}var d=this,e=$("#DeleteModal"),f=e.find(".modal-body");f.html("Slette denne raden?"),b&&f.prepend(this.displayErrorHelpers(b));var g=e.find("#DeleteSave");g.off("click").on("click",c),e.modal("show"),g.focus().select()},this.saveDeleteAction=function(a,b){function c(c){return f.isSaving=!1,c.Success===!1?(e.setModalError("#DeleteModal",c.Message,c.Errors),void e.build().activate()):(e.data.tbody.splice(b,1),e.build().activate(),void a.modal("hide"))}function d(a){f.isSaving=!1,e.build().activate();var b="<p>Sletting ikke mulig (feil "+a.status+").</p>";e.setModalError("#DeleteModal",b)}var e=this,f=this.data.tbody[b],g={};for(var h in f)if(f.hasOwnProperty(h)){if("undo"===h)continue;if("isSaving"===h)continue;g[h]=f[h]}var i={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,RowId:b,Data:JSON.stringify(g)};$.ajax({type:"POST",url:this.settings.deleteUrl,dataType:"json",data:i,success:c,error:d})},this.addCommentLink=function(){function a(){c.spawnCommentModal()}var c=this,d=b.getElementsByClassName("tcComment")[0];if(void 0!==d){var e=b.getElementsByClassName("tcActionMenu")[0],f=$(e).find(".commentEdit");if(0===f.length){var g=this.data&&this.data.table&&this.data.table.comment?this.data.table.comment.length:0,h=g>0?"Endre":"Legg til";f=$('<a class="tcActionRow commentEdit" tabindex="0">'+h+" kommentar</a>"),$(e).append(f)}f.on("click",a)}},this.spawnCommentModal=function(){function a(){return b.saveCommentAction(c)}var b=this,c=$("#CommentModal"),d=c.find(".modal-body"),e=$('<textarea onkeyup="TableCreator.updateCommentEditor(this); return false;"></textarea>'),f="";this.data.hasOwnProperty("table")&&this.data.table.hasOwnProperty("comment")&&(f=this.data.table.comment),e.val(this.decodeHtmlEntities(f)),d.html(e),d.append($('<div class="charactersLeft"><span>check</span></div>')),this.constructor.updateCommentEditor(e.get(0));var g=c.find("#CommentSave");g.off("click").on("click",a),c.modal("show"),e.height(e.prop("scrollHeight")+2),e.focus().select()},this.saveCommentAction=function(a){function b(a){var b=$("#CommentModal"),c=$("#CommentModal .errorDiv");switch(0===c.length&&(c=$('<div class="errorDiv alert alert-danger"></div>'),b.find(".modal-body").prepend(c)),a.status){case 404:c.html("<p>Ikke lagret:</p><li>Finner ikke lagringsplass (feil 404).</li>");break;default:c.html("<p>Lagring ikke mulig (feil "+a.status+").</p>")}b.modal("show")}function c(a){return a.Success===!1?void d.setModalError("#CommentModal",a.Message,a.Errors):(d.data.table.comment=a.SavedComment,d.build().activate(),void $("#CommentModal").modal("hide"))}var d=this,e=a.find("textarea"),f=e.val();if(!(f.length>900)){var g={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,RowId:-1,Data:JSON.stringify({tcTableComment:f})};$.ajax({type:"POST",url:this.settings.saveUrl,dataType:"json",data:g,success:c,error:b})}},this.decodeHtmlEntities=function(a){var b=this;return a=0===a?"0":a||"",a=a.toString(),a=a.replace(/&#(\d+);?/g,function(a,b){return String.fromCharCode(b)}).replace(/&#[xX]([A-Fa-f0-9]+);?/g,function(a,b){return String.fromCharCode(parseInt(b,16))}).replace(/&([^;\W]+;?)/g,function(a,c){var d=c.replace(/;$/,""),e=b.ENTITIES[c]||c.match(/;$/)&&b.ENTITIES[d];return"number"==typeof e?String.fromCharCode(e):"string"==typeof e?e:a})},this.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,"OElig;":338,"oelig;":339,"Scaron;":352,"scaron;":353,"Yuml;":376,"fnof;":402,"circ;":710,"tilde;":732,"Alpha;":913,"Beta;":914,"Gamma;":915,"Delta;":916,"Epsilon;":917,"Zeta;":918,"Eta;":919,"Theta;":920,"Iota;":921,"Kappa;":922,"Lambda;":923,"Mu;":924,"Nu;":925,"Xi;":926,"Omicron;":927,"Pi;":928,"Rho;":929,"Sigma;":931,"Tau;":932,"Upsilon;":933,"Phi;":934,"Chi;":935,"Psi;":936,"Omega;":937,"alpha;":945,"beta;":946,"gamma;":947,"delta;":948,"epsilon;":949,"zeta;":950,"eta;":951,"theta;":952,"iota;":953,"kappa;":954,"lambda;":955,"mu;":956,"nu;":957,"xi;":958,"omicron;":959,"pi;":960,"rho;":961,"sigmaf;":962,"sigma;":963,"tau;":964,"upsilon;":965,"phi;":966,"chi;":967,"psi;":968,"omega;":969,"thetasym;":977,"upsih;":978,"piv;":982,"ensp;":8194,"emsp;":8195,"thinsp;":8201,"zwnj;":8204,"zwj;":8205,"lrm;":8206,"rlm;":8207,"ndash;":8211,"mdash;":8212,"lsquo;":8216,"rsquo;":8217,"sbquo;":8218,"ldquo;":8220,"rdquo;":8221,"bdquo;":8222,"dagger;":8224,"Dagger;":8225,"bull;":8226,"hellip;":8230,"permil;":8240,"prime;":8242,"Prime;":8243,"lsaquo;":8249,"rsaquo;":8250,"oline;":8254,"frasl;":8260,"euro;":8364,"image;":8465,"weierp;":8472,"real;":8476,"trade;":8482,"alefsym;":8501,"larr;":8592,"uarr;":8593,"rarr;":8594,"darr;":8595,"harr;":8596,"crarr;":8629,"lArr;":8656,"uArr;":8657,"rArr;":8658,"dArr;":8659,"hArr;":8660,"forall;":8704,"part;":8706,"exist;":8707,"empty;":8709,"nabla;":8711,"isin;":8712,"notin;":8713,"ni;":8715,"prod;":8719,"sum;":8721,"minus;":8722,"lowast;":8727,"radic;":8730,"prop;":8733,"infin;":8734,"ang;":8736,"and;":8743,"or;":8744,"cap;":8745,"cup;":8746,"int;":8747,"there4;":8756,"sim;":8764,"cong;":8773,"asymp;":8776,"ne;":8800,"equiv;":8801,"le;":8804,"ge;":8805,"sub;":8834,"sup;":8835,"nsub;":8836,"sube;":8838,"supe;":8839,"oplus;":8853,"otimes;":8855,"perp;":8869,"sdot;":8901,"lceil;":8968,"rceil;":8969,"lfloor;":8970,"rfloor;":8971,"lang;":9001,"rang;":9002,"loz;":9674,"spades;":9824,"clubs;":9827,"hearts;":9829,"diams;":9830},this.callCallback=function(a){if(a&&"object"==typeof a){var b=a.fn,c=a.ctx;return"function"==typeof b&&c?b.call(c):b.call({})}},this.isEqualToTableRowArray=function(a){if(!a||a.constructor!==Array)return!1;if(a.length!==this.data.tbody.length)return!1;for(var b,c,d=0;d<a.length;++d){if(b=a[d],c=this.data.tbody[d],!b||"object"!=typeof b||!c||"object"!=typeof c)return!1;for(var e in b)if(b.hasOwnProperty(e)){if(!c.hasOwnProperty(e))return!1;if(b[e]!==c[e])return!1}for(var f in c)if(c.hasOwnProperty(f)&&!b.hasOwnProperty(f)){var g="undo"!==f&&("isSaving"!==f&&(!!c[f]&&"0"!==c[f]));if(g)return!1}}return!0},this):new TableCreator(a,b)}String.prototype.isNumeric=function(){"use strict";return!isNaN(parseFloat(this))&&isFinite(this)},Array.prototype.clean=function(){"use strict";for(var a=0;a<this.length;a++)""===this[a]&&this.splice(a,1);return this},TableCreator.updateCommentEditor=function(a){a.value=a.value.replace(/\n/g,"");var b=a.scrollHeight>a.offsetHeight?a.scrollHeight:a.offsetHeight;a.style.height=b+"px";var c=a.value.length,d=$("#CommentModal .charactersLeft span"),e=900-c;d.text(e),e>=0?(a.classList.remove("minus"),$("#CommentModal #CommentSave").prop("disabled",!1)):(a.classList.add("minus"),$("#CommentModal #CommentSave").prop("disabled",!0))},"undefined"!=typeof window?window.TableCreator=TableCreator:"undefined"!=typeof global&&(global.TableCreator=TableCreator);
/*! tablecreator 2016-09-27 */
"use strict";function TableCreator(a,b){return this instanceof TableCreator?(this.ctx=this,this.data=a,this.el=b,this.el.onkeyup=function(a){return 13!=a.which&&13!=a.keyCode||a.path[0].click(),console.log(a),!0},this.settings={schemaId:null,instanceId:null,precision:2,isResizable:!1,createUrl:null,saveUrl:null,deleteUrl:null},this.build=function(){return this.buildTable(this.data,this.el),this},this.setCreateUrl=function(a){return this.settings.createUrl=a,this},this.setSaveUrl=function(a){return this.settings.saveUrl=a,this},this.setDeleteUrl=function(a){return this.settings.deleteUrl=a,this},this.init=function(){return this.data.hasOwnProperty("table")&&(this.data.table.hasOwnProperty("schemaId")&&(this.settings.schemaId=this.data.table.schemaId),this.data.table.hasOwnProperty("instanceId")&&(this.settings.instanceId=this.data.table.instanceId),this.data.table.hasOwnProperty("settings")&&this.data.table.settings.hasOwnProperty("isResizable")&&(this.settings.isResizable=this.data.table.settings.isResizable)),this},this.init(),this.activate=function(){if(null===this.settings.createUrl&&console.warn("Url to create row is not set."),null===this.settings.saveUrl&&console.warn("Url to save changes is not set."),null===this.settings.deleteUrl&&console.warn("Url to delete rows is not set."),$(".tcActionRow").removeClass("hide"),0===$("#EditModal").length&&this.createModal("Edit","Endring","Lukk","Lagre"),this.addEditLinks(),0===$("#UndoModal").length&&this.createModal("Undo","Angre","Lukk","Utfør"),this.addUndoLinks(),0===$("#DeleteModal").length&&this.createModal("Delete","Sletting","Avbryt","Slett"),this.addDeleteLinks(),this.settings.isResizable){var a=this,b=$('<a class="tcActionRow add" tabindex="0">Legg til ny rad</a>'),c=$(this.el).find(".tcActionMenu");c.append(b),b.on("click",function(){a.newAction()})}return 0===$("#CommentModal").length&&this.createModal("Comment","Kommentar","Avbryt","Lagre"),this.addCommentLink(),this},this.buildTable=function(a,b){var c="";a.hasOwnProperty("table")&&(c=a.table.hasOwnProperty("class")?a.table["class"]:""),a.hasOwnProperty("table")&&a.table.hasOwnProperty("settings")&&a.table.settings.hasOwnProperty("decimals")&&"number"==typeof a.table.settings.decimals&&(this.settings.precision=a.table.settings.decimals);var d="";a.hasOwnProperty("table")&&a.table.hasOwnProperty("title")&&(d+="<span>"+a.table.title+"</span>"),d+='<table class="tc_table '+c+'"><thead>';for(var e=0;e<a.thead.rows.length;++e){var f=a.thead.rows[e];d+="<tr>";for(var g=0;g<f.length;++g){var h=f[g],i=h.hasOwnProperty("colspan")?' colspan="'+h.colspan+'"':"",j=h.hasOwnProperty("title")?h.title:"",k=h.hasOwnProperty("class")?" "+h["class"]:"";d+='<th class="tcTableHeaders'+k+'"'+i+">"+j+"</th>"}d+="</tr>"}d+="<tr>";for(var l=0;l<a.thead.cols.length;++l){var m=a.thead.cols[l],n=m.hasOwnProperty("title")?m.title:"",o=m.hasOwnProperty("class")?m["class"]:"";o+="number"===m.type?" number":"",o+="string"===m.type?" tcLeftAlign":"",o+=m.hasOwnProperty("type")?"":" tcLeftAlign",d+='<th class="'+o+'">'+n+"</th>"}d+="</tr>",d+="</thead><tbody>";for(var p=0;p<a.tbody.length;++p){var q=a.tbody[p];d+="<tr>";for(var r=a.thead.cols,s=0;s<r.length;++s){var t=r[s].id,u=q.hasOwnProperty(t)?q[t]:"",v=r[s].hasOwnProperty("class")?r[s]["class"]:"";if(r[s].hasOwnProperty("method")){var w=r[s].method,x=r[s].hasOwnProperty("type")?r[s].type:"",y=this.parseMethod(w,q);y="number"==x?this.formatData(y,"number"):"percent"==x?this.formatData(y,"percent"):y,d+='<td class="'+x+" "+v+'">'+y+"</td>"}else if(r[s].hasOwnProperty("type"))switch(r[s].type){case"method":u=this.parseMethod(u,q),d+='<td class="'+r[s].type+" "+v+'">'+this.formatData(u,"number")+"</td>";break;case"number":d+='<td class="'+r[s].type+" "+v+'">'+this.formatData(u,"number")+"</td>";break;case"percent":d+='<td class="'+r[s].type+" "+v+'">'+this.formatData(u,"percent")+"</td>";break;case"string":case"undefined":d+='<td class="tcLeftAlign '+r[s].type+" "+v+'">'+u+"</td>";break;case"index":d+="<td>"+(p+1)+"</td>";break;case"actionArray":d+='<td class="tcActionRow hide '+v+'">';var z=!!q.hasOwnProperty("isSaving")&&q.isSaving;z===!0&&(d+='<i class="fa fa-refresh fa-spin"></i>');var A=r[s].hasOwnProperty("actions")?r[s].actions:null;if(null!==A&&A.constructor===Array)for(var B=0;B<A.length;++B)switch(A[B]){case"undo":q.hasOwnProperty("undo")&&null!==q.undo&&(d+='<a title="Angre" class="tcAction undo" data-tc_action="undo" data-tc_row="'+p+'" tabindex="0">angre</a>');break;case"edit":d+='<a title="Rediger" class="tcAction edit" data-tc_action="edit" data-tc_row="'+p+'" tabindex="0">rediger</a>';break;case"delete":this.settings.isResizable&&(d+='<a title="Slett" class="tcAction delete" data-tc_action="delete" data-tc_row="'+p+'" tabindex="0">slett</a>')}d+="</td>";break;default:d+='<td class="'+r[s].type+" "+v+'">'+u+"</td>"}else d+='<td class="tcLeftAlign '+v+'"></td>'}d+="</tr>"}if(d+="</tbody>",a.tfoot.hasOwnProperty("cols")&&Array.isArray(a.tfoot.cols)&&a.tfoot.cols.length>0){d+="<tfoot><tr>";for(var C=0;C<a.tfoot.cols.length;++C){var D,E=a.tfoot.cols[C],F="";C<a.thead.cols.length&&(F=a.thead.cols[C].hasOwnProperty("class")?a.thead.cols[C]["class"]:"");var G=E.hasOwnProperty("class")?E["class"]:"";E.hasOwnProperty("title")?d+='<td class="'+F+" "+G+' string">'+E.title+"</td>":E.hasOwnProperty("method")?(D=this.parseMethod(E.method,a),d+='<td class="'+F+" "+G+' number">'+this.formatData(D,"number")+"</td>"):d+='<td class="'+F+'"></td>'}d+="</tfoot></tr>"}d+="</table>",d+='<div class="tcActionMenu"></div>',d+='<div class="tcComment"><span class="comment"></span></div>',b.innerHTML=d;var H=b.getElementsByClassName("tcComment")[0],I=b.getElementsByClassName("tc_table")[0].offsetWidth;H.setAttribute("style","width:"+I+"px"),a.hasOwnProperty("table")&&a.table.hasOwnProperty("comment")&&"string"==typeof a.table.comment&&(H.querySelector(".comment").innerHTML=a.table.comment)},this.formatData=function(a,b){var c=a;switch(b){case"number":var d=c.toString().split(".");d[0]=d[0].replace(/\B(?=(\d{3})+(?!\d))/g," "),c=d.join(".");var e='<span class="minus">'+c.replace("-","- ")+"</span>";c="-"==c.charAt(0)?e:c;break;case"percent":c=c.toString().isNumeric()?c.toString()+" %":"0 %";var f='<span class="minus">'+c.replace("-","- ")+"</span>";c="-"==c.charAt(0)?f:c}return c},this.methods={sum:function(a){for(var b=0,c=0;c<a.length;++c)b+=!a[c]||/^\s*$/.test(a[c])?0:parseFloat(a[c]);return b},avg:function(a){for(var b=0,c=0;c<a.length;++c)b+=!a[c]||/^\s*$/.test(a[c])?0:parseFloat(a[c]);return b/a.length},div:function(a){if(0===a.length)return NaN;if(1===a.length)return a[0];for(var b=parseFloat(a[0]),c=1;c<a.length;++c)b/=!a[c]||/^\s*$/.test(a[c])?1:a[c];return b},mult:function(a){if(a.length<1)return NaN;for(var b=a[0],c=1;c<a.length;++c)b*=!a[c]||/^\s*$/.test(a[c])?1:a[c];return b}},this.calculate=function(a,b,c){var d,e=[];if(c.hasOwnProperty("tbody"))for(var f=c.thead.cols,g=c.tbody,h=0;h<b.length;++h){var i=b[h];if("number"!=typeof i){var j=!1;"string"==typeof i&&"-"===i.charAt(0)&&(j=!0,i=i.slice(1));for(var k=null,l=0;l<f.length;++l)if(f[l].id===i){k=f[l];break}if(null!==k&&k.hasOwnProperty("method")){var m=this.parseMethod(k.method,c);e.push(j?-m:m)}else for(var n=0;n<g.length;++n){var o=g[n];if(o.hasOwnProperty(i))if("method"===k.type){var p=this.parseMethod(o[i],o);e.push(j?-p:p)}else"number"===k.type&&e.push(j?-o[i]:o[i])}}else e.push(i)}else for(var q=0;q<b.length;++q){var r=b[q];if("number"==typeof r)e.push(r);else if(c.hasOwnProperty(r))e.push(c[r]);else if("-"===r.charAt(0)&&c.hasOwnProperty(r.slice(1)))e.push(-c[r.slice(1)]);else for(var s=r.slice(1),t=this.data.thead.cols,u=0;u<t.length;++u)if(t[u].id===r||t[u].id===s)if(t[u].hasOwnProperty("method")){var v=this.parseMethod(t[u].method,c);v=t[u].id===s?-v:v,e.push(v)}else e.push(0)}return d=this.methods[a](e)},this.parseMethod=function(a,b){var c=a.replace(/\s+/g,"");c=c.split(/([\,\(\)])/).clean();for(var d=[[]],e=[],f=0;f<c.length;++f){var g=c[f];if(this.methods.hasOwnProperty(g))e.push(g);else if("("===g)d.push([]);else if(g.isNumeric())d[d.length-1].push(parseFloat(g));else if(")"===g){var h=e.pop(),i=d.pop(),j=this.calculate(h,i,b);d[d.length-1].push(j)}else","!==g&&d[d.length-1].push(g)}var k=2;"number"==typeof this.settings.precision&&(k=this.settings.precision);var l=parseFloat(d.pop()).toFixed(k);return l=isNaN(l)?"":l},this.createModal=function(a,b,c,d){var e=$('<div class="modal-header">'),f=$('<div class="modal-body">'),g=$('<div class="modal-footer">'),h=$('<button type="button" class="btn btn-primary" id="'+a+'Save">'+d+"</button>");e.append($('<button type="button" class="close" data-dismiss="modal" aria-label="Lukk"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">'+b+"</h4>")),g.append($('<button type="button" class="btn btn-default" data-dismiss="modal">'+c+"</button>")),g.append(h);var i=$('<div id="'+a+'Modal" class="modal face" role="dialog">').append($('<div class="modal-dialog">').append($('<div class="modal-content">').append(e).append(f).append(g)));$("body").append(i),i.on("keyup",function(a){return 13!=a.which&&13!=a.keyCode||h.click(),!0})},this.displayErrorHelper=function(a){if(a=a?a.constructor===String?[a]:a.constructor===Array?a:null:null){var b=$('<div class="panel panel-danger">');b.append('<div class="panel-heading">Feil</div>');var c=$('<div class="panel-body"></div>');b.append(c);for(var d=0;d<a.length;++d){var e=$("<p>");e.html(a[d]),c.append(e)}return b}return""},this.addEditLinks=function(){function a(a){var c=a.target.getAttribute("data-tc_row");b.spawnEditModal(c)}var b=this,c=$(this.el).find(".tcAction.edit");c.on("click",a)},this.spawnEditModal=function(a,b){function c(){return d.saveEditAction(f,a)}var d=this,e=$("#EditModal"),f=e.find(".modal-body");f.data("rowIdx",a),f.html(this.editFor(a)),b&&f.prepend(this.displayErrorHelper(b));var g=e.find("#EditSave");g.off("click").on("click",c),e.modal("show"),f.find(".form-control").first().focus().select()},this.editFor=function(a){for(var b=this.data.tbody[a],c=this.data.thead.cols,d=this.data.table,e="",f=0;f<c.length;++f){var g=c[f].id,h=c[f].title,i=c[f].type,j=null,k=!!c[f].hasOwnProperty("method"),l=!!c[f].hasOwnProperty("editable")&&c[f].editable;if(!k&&"method"!==i&&"actionArray"!==i&&l){switch(e+='<div class="form-group row">',e+='<label for="tcEdit_'+g+'" class="control-label col-md-4">'+h+"</label>",e+="number"===i?'<div class="col-md-push-3 col-md-5">':'<div class="col-md-8">',d.pool.hasOwnProperty(g)&&d.pool[g].constructor===Array&&(i="dropdown",j=d.pool[g]),i){default:case"undefined":case"string":e+='<input type="text" class="form-control" name="tcEdit_'+g+'" value="'+b[g]+'"/>';break;case"number":var m=Math.pow(10,d.settings.decimals);e+='<input type="number" class="form-control" step="'+(m?1/m:1)+'" name="tcEdit_'+g+'" value="'+b[g]+'"/>';break;case"percent":e+='<input type="number" class="form-control" step="0.1" name="tcEdit_'+g+'" value="'+b[g]+'"/>';break;case"dropdown":e+='<select class="form-control" name="tcEdit_'+g+'">';for(var n=0;n<j.length;++n){var o=b[g]===j[n]?' selected="selected"':"";e+="<option"+o+">"+j[n]+"</option>"}e+="</select>"}e+="</div></div>"}}return e},this.saveEditAction=function(a,b){function c(a){o.isSaving=!1,e.build().activate();var b=$("#EditModal"),c=$("#EditModal .errorDiv");switch(0===c.length&&(c=$('<div class="errorDiv alert alert-danger"></div>'),b.find(".modal-body").prepend(c)),a.status){case 404:c.html("<p>Ikke lagret:</p><li>Finner ikke lagringsplass (feil 404).</li>");break;default:c.html("<p>Lagring ikke mulig (feil "+a.status+").</p>")}b.modal("show")}function d(a){if(o.isSaving=!1,a.Success===!1)return e.setModalError("#EditModal",a.Message,a.Errors),void e.build().activate();for(var c in w)w.hasOwnProperty(c)&&(e.data.tbody[b][c]=w[c]);e.data.tbody[b].undo=u,e.build().activate(),$("#EditModal").modal("hide")}var e=this,f=[],g=!0,h=a.find("input[name^='tcEdit_']");if(h.each(function(){var a=$(this);$(this).callProp("checkValidity")===!1?(g=!1,a.addClass("tc_warning")):a.removeClass("tc_warning")}),g!==!1){var i,j,k,l,m=a.find("input[name^='tcEdit_']");m.each(function(a,b){i=$(b),j=i.attr("name").slice("tcEdit_".length),k=i.val(),l=i.attr("type"),f.push({key:j,value:k,type:l})});var n=a.find("select[name^='tcEdit_']");n.each(function(a,b){i=$(b),j=i.attr("name").slice("tcEdit_".length),k=i.val(),f.push({key:j,value:k})});for(var o=this.data.tbody[b],p={},q={},r=!0,s=0;s<f.length;++s){if(j=f[s].key,k=f[s].value,l=f[s].hasOwnProperty("type")?f[s].type:null,"number"==l){if(k=parseFloat(k),o.hasOwnProperty(j)&&(o[j]=parseFloat(o[j])),isNaN(k)){var t=a.find("[name^='tcEdit_"+j+"']");t.addClass("tc_warning"),r=!1;continue}k=k.toString()}o.hasOwnProperty(j)?o[j]!==k&&(p[j]=o[j],q[j]=k):(p[j]=null,q[j]=k)}if(!r)return void this.spawnEditModal(b,["Et innskrevet tall ble ikke godkjent. Prøv igjen."]);if($.isEmptyObject(p))return console.log("Ingen endringer"),void $("#EditModal").modal("hide");o.isSaving=!0,this.build().activate(),o.hasOwnProperty("undo")||(o.undo=null);var u={undo:o.undo};for(var v in p)p.hasOwnProperty(v)&&(u[v]=p[v]);var w={};for(var x in q)q.hasOwnProperty(x)&&(w[x]=q[x]);var y={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,RowId:b,Data:JSON.stringify(w)};$.ajax({type:"POST",url:this.settings.saveUrl,dataType:"json",data:y,success:d,error:c})}},this.setModalError=function(a,b,c){var d=$(a),e=d.find(".errorDiv");if(0===e.length&&(e=$('<div class="errorDiv alert alert-danger"></div>'),d.find(".modal-body").prepend(e)),b&&e.html("<p>"+b+"</p>"),c&&c.constructor===Array)for(var f=0;f<c.length;++f)e.append($("<li>"+c[f]+"</li>"))},this.removeLastUndo=function(a){var b=this.data.tbody[a];if(b.hasOwnProperty("undo")&&null!==b.undo){var c=b.undo,d=b.undo.undo;for(var e in c)c.hasOwnProperty(e)&&"undo"!==e&&(b.property=c.property);b.undo=d}},this.addUndoLinks=function(){function a(a){var c=a.target.getAttribute("data-tc_row");b.spawnUndoModal(c)}var b=this,c=$(this.el).find(".tcAction.undo");c.on("click",a)},this.spawnUndoModal=function(a,b){function c(){d.undoEditAction(a)}var d=this,e=$("#UndoModal"),f=e.find(".modal-body");f.html("<p>Angre og gå eit steg tilbake?</p>"),b&&f.prepend(this.displayErrorHelper(b));var g=e.find("#UndoSave");g.off("click").on("click",c),e.modal("show"),g.focus().select()},this.undoEditAction=function(a){function b(a){d.isSaving=!1,e.build().activate();var b=$("#UndoModal"),c=$("#UndoModal .errorDiv");switch(0===c.length&&(c=$('<div class="errorDiv alert alert-danger"></div>'),b.find(".modal-body").prepend(c)),a.status){case 404:c.html("<p>Fikk ikke angret:</p><li>Finner ikke lagringsplass (feil 404).</li>");break;default:c.html("<p>Angring ikke mulig (feil "+a.status+").</p>")}}function c(b){if(b.Success===!1)return e.setModalError("#UndoModal",b.Message,b.Errors),e.removeLastUndo(a),d.isSaving=!1,void e.build().activate();for(var c in f)f.hasOwnProperty(c)&&(d[c]=f[c]);e.removeLastUndo(a),d.isSaving=!1,e.build().activate(),$("#UndoModal").modal("hide")}var d=this.data.tbody[a];if(d.undo){d.isSaving=!0,this.build().activate();var e=this,f={};for(var g in d)d.hasOwnProperty(g)&&"undo"!==g&&(f[g]=d[g]);for(var h in d.undo)d.undo.hasOwnProperty(h)&&"undo"!==h&&(f[h]=d.undo[h]);var i={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,RowId:a,Data:JSON.stringify(f)};$.ajax({type:"POST",url:this.settings.saveUrl,dataType:"json",data:i,success:c,error:b})}},this.newAction=function(){function a(){b.constructRow(c)}var b=this,c=$("#EditModal"),d=c.find(".modal-body");d.html(this.blankRowEditor());var e=c.find("#EditSave");e.off("click").on("click",a),c.modal("show")},this.constructRow=function(a){function b(a){var b=$("#EditModal"),c=b.find(".errorDiv");switch(0===c.length&&(c=$('<div class="errorDiv alert alert-danger"></div>'),b.find(".modal-body").prepend(c)),a.status){case 404:c.html("<p><b>Ikke lagret:</b> Finner ikke lagringsplass (feil 404).</p>");break;default:c.html("<p><b>Ikke lagret:</b> Lagring ikke mulig (feil "+a.status+").</p>")}l.find("i.fa-spin").fadeOut(1e3,function(){$(this).remove()}),l.find("i.fa-save").fadeOut(1e3,function(){$(this).remove()})}function c(b){if(b.Success!==!0){var c=b.Errors&&b.Errors.constructor===Array?b.Errors:null;return g.setModalError("#EditModal",b.Message,c),l.find("i.fa-spin").fadeOut(500,function(){$(this).remove()}),void l.find("i.fa-save").fadeOut(1e3,function(){$(this).remove()})}g.data.tbody.push(i),g.build().activate(),a.modal("hide"),l.find("i.fa").remove()}console.log(a);var d,e,f,g=this,h=!0,i=this.data.table.template.addTpl||{},j=a.find("[name^='tcEdit_']");if(j.each(function(){if(d=$(this),console.log("elem:"),console.log(d),d.callProp("checkValidity")===!1?(h=!1,d.addClass("tc_warning")):(d.removeClass("tc_warning"),e=d.attr("name").slice("tcEdit_".length),f=d.val(),i[e]=f),d.is("select")){var a=!g.data.table.pool.hasOwnProperty(e),b=!a&&-1===$.inArray(f,g.data.table.pool[e]);(a||b)&&(h=!1,d.addClass("tc_warning"))}}),h===!1)return void console.log("validity failed");if(null!==this.settings.createUrl){var k={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,Data:JSON.stringify(i)},l=a.find(".modal-footer");l.prepend($('<i class="fa fa-save fa-lg" style="margin-right: 1em;"></i>')),l.prepend($('<i class="fa fa-refresh fa-spin" style="margin-right: 1em;"></i>')),$.ajax({type:"POST",url:this.settings.createUrl,dataType:"json",data:k,success:c,error:b})}},this.blankRowEditor=function(){var a=this.data.thead.cols,b=this.data.table,c="",d=null;b.hasOwnProperty("template")&&b.template.hasOwnProperty("addTpl")&&(d=b.template.addTpl);for(var e=0;e<a.length;++e){var f=a[e].id,g=a[e].title,h=a[e].type,i=null,j=!!a[e].hasOwnProperty("method"),k=!!a[e].hasOwnProperty("editable")&&a[e].editable,l=null!==d&&d.hasOwnProperty(f)?d[f]:null;if(!j&&"method"!==h&&"actionArray"!==h&&k){switch(c+='<div class="form-group row">',c+='<label for="tcEdit_'+f+'" class="control-label col-md-4">'+g+"</label>",c+="number"===h?'<div class="col-md-push-3 col-md-5">':'<div class="col-md-8">',b.pool.hasOwnProperty(f)&&b.pool[f].constructor===Array&&(h="dropdown",i=b.pool[f]),h){default:case"undefined":case"string":c+='<input type="text" class="form-control" name="tcEdit_'+f+'" '+(null===l?"":'value="'+l+'"')+"/>";break;case"number":var m=Math.pow(10,b.settings.decimals);c+='<input type="number" class="form-control" step="'+(m?1/m:1)+'" name="tcEdit_'+f+'" '+(null===l?'value="0"':'value="'+l+'"')+"/>";break;case"percent":c+='<input type="number" class="form-control" step="0.1" name="tcEdit_'+f+'"'+(null===l?'value="0"':'value="'+l+'"')+"/>";break;case"dropdown":c+='<select class="form-control" name="tcEdit_'+f+'">';var n=null!==l?" selected":"";c+="<option"+n+" disabled>Velg en...</option>";for(var o=0;o<i.length;++o)n=l===i[o]?" selected":"",c+="<option"+n+">"+i[o]+"</option>";c+="</select>"}c+="</div></div>"}}return c},this.addDeleteLinks=function(){function a(a){var c=a.target.getAttribute("data-tc_row");b.spawnDeleteModal(c)}var b=this,c=$(this.el).find(".tcAction.delete");c.on("click",a)},this.spawnDeleteModal=function(a,b){function c(){return d.saveDeleteAction(e,a)}var d=this,e=$("#DeleteModal"),f=e.find(".modal-body");f.html("Slette denne raden?"),b&&f.prepend(this.displayErrorHelpers(b));var g=e.find("#DeleteSave");g.off("click").on("click",c),e.modal("show"),g.focus().select()},this.saveDeleteAction=function(a,b){function c(c){return f.isSaving=!1,c.Success===!1?(e.setModalError("#DeleteModal",c.Message,c.Errors),void e.build().activate()):(e.data.tbody.splice(b,1),e.build().activate(),void a.modal("hide"))}function d(a){f.isSaving=!1,e.build().activate();var b="<p>Sletting ikke mulig (feil "+a.status+").</p>";e.setModalError("#DeleteModal",b)}var e=this,f=this.data.tbody[b],g={};for(var h in f)if(f.hasOwnProperty(h)){if("undo"===h)continue;if("isSaving"===h)continue;g[h]=f[h]}var i={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,RowId:b,Data:JSON.stringify(g)};$.ajax({type:"POST",url:this.settings.deleteUrl,dataType:"json",data:i,success:c,error:d})},this.addCommentLink=function(){function a(){c.spawnCommentModal()}var c=this,d=b.getElementsByClassName("tcComment")[0];if(void 0!==d){var e=b.getElementsByClassName("tcActionMenu")[0],f=$(e).find(".commentEdit");0===f.length&&(f=$('<a class="tcActionRow commentEdit" tabindex="0">Rediger kommentar</a>'),$(e).append(f)),f.on("click",a)}},this.spawnCommentModal=function(){function a(){return b.saveCommentAction(c)}var b=this,c=$("#CommentModal"),d=c.find(".modal-body"),e=$("<textarea onkeyup=\"$(this).val($(this).val().replace(/\\n/g, '')); this.style.height=(this.scrollHeight+2)+'px'; return false;\"></textarea>"),f="";this.data.hasOwnProperty("table")&&this.data.table.hasOwnProperty("comment")&&(f=this.data.table.comment),e.val(this.decodeHtmlEntities(f)),d.html(e);var g=c.find("#CommentSave");g.off("click").on("click",a),c.modal("show"),e.height(e.prop("scrollHeight")+2),e.focus().select()},this.saveCommentAction=function(a){function b(a){var b=$("#CommentModal"),c=$("#CommentModal .errorDiv");switch(0===c.length&&(c=$('<div class="errorDiv alert alert-danger"></div>'),b.find(".modal-body").prepend(c)),a.status){case 404:c.html("<p>Ikke lagret:</p><li>Finner ikke lagringsplass (feil 404).</li>");break;default:c.html("<p>Lagring ikke mulig (feil "+a.status+").</p>")}b.modal("show")}function c(a){return a.Success===!1?void d.setModalError("#CommentModal",a.Message,a.Errors):(d.data.table.comment=a.SavedComment,d.build().activate(),void $("#CommentModal").modal("hide"))}var d=this,e=a.find("textarea"),f=e.val();console.log("escapedComment"),console.log({comment:f});var g={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,RowId:-1,Data:JSON.stringify({tcTableComment:f})};$.ajax({type:"POST",url:this.settings.saveUrl,dataType:"json",data:g,success:c,error:b})},this.decodeHtmlEntities=function(a){var b=this;return a=a.replace(/&#(\d+);?/g,function(a,b){return String.fromCharCode(b)}).replace(/&#[xX]([A-Fa-f0-9]+);?/g,function(a,b){return String.fromCharCode(parseInt(b,16))}).replace(/&([^;\W]+;?)/g,function(a,c){var d=c.replace(/;$/,""),e=b.ENTITIES[c]||c.match(/;$/)&&b.ENTITIES[d];return"number"==typeof e?String.fromCharCode(e):"string"==typeof e?e:a})},this.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,"OElig;":338,"oelig;":339,"Scaron;":352,"scaron;":353,"Yuml;":376,"fnof;":402,"circ;":710,"tilde;":732,"Alpha;":913,"Beta;":914,"Gamma;":915,"Delta;":916,"Epsilon;":917,"Zeta;":918,"Eta;":919,"Theta;":920,"Iota;":921,"Kappa;":922,"Lambda;":923,"Mu;":924,"Nu;":925,"Xi;":926,"Omicron;":927,"Pi;":928,"Rho;":929,"Sigma;":931,"Tau;":932,"Upsilon;":933,"Phi;":934,"Chi;":935,"Psi;":936,"Omega;":937,"alpha;":945,"beta;":946,"gamma;":947,"delta;":948,"epsilon;":949,"zeta;":950,"eta;":951,"theta;":952,"iota;":953,"kappa;":954,"lambda;":955,"mu;":956,"nu;":957,"xi;":958,"omicron;":959,"pi;":960,"rho;":961,"sigmaf;":962,"sigma;":963,"tau;":964,"upsilon;":965,"phi;":966,"chi;":967,"psi;":968,"omega;":969,"thetasym;":977,"upsih;":978,"piv;":982,"ensp;":8194,"emsp;":8195,"thinsp;":8201,"zwnj;":8204,"zwj;":8205,"lrm;":8206,"rlm;":8207,"ndash;":8211,"mdash;":8212,"lsquo;":8216,"rsquo;":8217,"sbquo;":8218,"ldquo;":8220,"rdquo;":8221,"bdquo;":8222,"dagger;":8224,"Dagger;":8225,"bull;":8226,"hellip;":8230,"permil;":8240,"prime;":8242,"Prime;":8243,"lsaquo;":8249,"rsaquo;":8250,"oline;":8254,"frasl;":8260,"euro;":8364,"image;":8465,"weierp;":8472,"real;":8476,"trade;":8482,"alefsym;":8501,"larr;":8592,"uarr;":8593,"rarr;":8594,"darr;":8595,"harr;":8596,"crarr;":8629,"lArr;":8656,"uArr;":8657,"rArr;":8658,"dArr;":8659,"hArr;":8660,"forall;":8704,"part;":8706,"exist;":8707,"empty;":8709,"nabla;":8711,"isin;":8712,"notin;":8713,"ni;":8715,"prod;":8719,"sum;":8721,"minus;":8722,"lowast;":8727,"radic;":8730,"prop;":8733,"infin;":8734,"ang;":8736,"and;":8743,"or;":8744,"cap;":8745,"cup;":8746,"int;":8747,"there4;":8756,"sim;":8764,"cong;":8773,"asymp;":8776,"ne;":8800,"equiv;":8801,"le;":8804,"ge;":8805,"sub;":8834,"sup;":8835,"nsub;":8836,"sube;":8838,"supe;":8839,"oplus;":8853,"otimes;":8855,"perp;":8869,"sdot;":8901,"lceil;":8968,"rceil;":8969,"lfloor;":8970,"rfloor;":8971,"lang;":9001,"rang;":9002,"loz;":9674,"spades;":9824,"clubs;":9827,"hearts;":9829,"diams;":9830},this):new TableCreator(a,b)}String.prototype.isNumeric=function(){return!isNaN(parseFloat(this))&&isFinite(this)},Array.prototype.clean=function(){for(var a=0;a<this.length;a++)""===this[a]&&this.splice(a,1);return this};
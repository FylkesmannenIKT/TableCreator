/*! tablecreator 2016-07-18 */
"use strict";function TableCreator(a,b){return this instanceof TableCreator?(this.ctx=this,this.data=a,this.el=b,this.settings={precision:2},this.build=function(){return this.buildTable(this.data,this.el),this},this.activate=function(){return this.addEditLinks(),this},this.buildTable=function(a,b){var c="";a.hasOwnProperty("table")&&(c=a.table.hasOwnProperty("class")?a.table["class"]:""),a.hasOwnProperty("table")&&a.table.hasOwnProperty("settings")&&a.table.settings.hasOwnProperty("decimals")&&"number"==typeof a.table.settings.decimals&&(this.settings.precision=a.table.settings.decimals);for(var d='<table class="tc_table '+c+'"><thead>',e=0;e<a.thead.rows.length;++e){var f=a.thead.rows[e];d+="<tr>";for(var g=0;g<f.length;++g){var h=f[g],i=h.hasOwnProperty("colspan")?' colspan="'+h.colspan+'"':"",j=h.hasOwnProperty("title")?h.title:"";d+='<th class="tcTableHeaders" '+i+">"+j+"</th>"}d+="</tr>"}d+="<tr>";for(var k=0;k<a.thead.cols.length;++k){var l=a.thead.cols[k],m=l.hasOwnProperty("title")?l.title:null,n=l.hasOwnProperty("class")?l["class"]:"";d+='<th class="'+n+'">'+m+"</th>"}d+="</tr>",d+="</thead><tbody>";for(var o=0;o<a.tbody.length;++o){var p=a.tbody[o];d+="<tr>";for(var q=a.thead.cols,r=0;r<q.length;++r){var s=q[r].id,t=p.hasOwnProperty(s)?p[s]:"",u=q[r].hasOwnProperty("class")?q[r]["class"]:"";if(q[r].hasOwnProperty("method")){var v=q[r].method,w=q[r].hasOwnProperty("type")?q[r].type:"",x=this.parseMethod(v,p);x="number"==w?this.formatData(x,"number"):x,d+='<td class="'+w+" "+u+'">'+x+"</td>"}else if(q[r].hasOwnProperty("type"))switch(q[r].type){case"method":t=this.parseMethod(t,p),d+='<td class="'+q[r].type+" "+u+'">'+this.formatData(t,"number")+"</td>";break;case"number":d+='<td class="'+q[r].type+" "+u+'">'+this.formatData(t,"number")+"</td>";break;case"string":case"undefined":d+='<td class="tcLeftAlign '+q[r].type+" "+u+'">'+t+"</td>";break;case"index":d+="<td>"+(o+1)+"</td>";break;case"actionArray":d+='<td class="tcRightAlign '+u+'">';var y=p.hasOwnProperty("cache")?p.cache:null;null!==y&&(d+='<i class="fa fa-refresh fa-spin"></i>');var z=q[r].hasOwnProperty("actions")?q[r].actions:null;if(null!==z&&z.constructor===Array)for(var A=0;A<z.length;++A)switch(z[A]){case"edit":d+='<span class="tcAction edit" data-tc_action="edit" data-tc_row="'+o+'">rediger</span>'}d+="</td>";break;default:d+='<td class="'+q[r].type+" "+u+'">'+t+"</td>"}else d+='<td class="tcLeftAlign '+u+'"></td>'}d+="</tr>"}if(d+="</tbody>",a.tfoot.hasOwnProperty("cols")&&Array.isArray(a.tfoot.cols)&&a.tfoot.cols.length>0){d+="<tfoot><tr>";for(var B=0;B<a.tfoot.cols.length;++B){var C,D=a.tfoot.cols[B],E="";B<a.thead.cols.length&&(E=a.thead.cols[B].hasOwnProperty("class")?a.thead.cols[B]["class"]:"");var F=D.hasOwnProperty("class")?D["class"]:"";D.hasOwnProperty("title")?d+='<td class="'+E+" "+F+' string">'+D.title+"</td>":D.hasOwnProperty("method")?(C=this.parseMethod(D.method,a),d+='<td class="'+E+" "+F+' number">'+this.formatData(C,"number")+"</td>"):d+='<td class="'+E+'"></td>'}d+="</tfoot></tr>"}d+="</table>",b.innerHTML=d},this.formatData=function(a,b){var c=a;switch(b){case"number":var d=c.toString().split(".");d[0]=d[0].replace(/\B(?=(\d{3})+(?!\d))/g," "),c=d.join(".");var e='<span class="minus">'+c.replace("-","- ")+"</span>";c="-"==c.charAt(0)?e:c}return c},this.methods={sum:function(a){for(var b=0,c=0;c<a.length;++c)b+=parseFloat(a[c]);return b},avg:function(a){for(var b=0,c=0;c<a.length;++c)b+=parseFloat(a[c]);return b/a.length}},this.calculate=function(a,b,c){var d,e=[];if(c.hasOwnProperty("tbody"))for(var f=c.thead.cols,g=c.tbody,h=0;h<b.length;++h){var i=b[h];if("number"!=typeof i){var j=!1;"string"==typeof i&&"-"===i.charAt(0)&&(j=!0,i=i.slice(1));for(var k=null,l=0;l<f.length;++l)if(f[l].id===i){k=f[l];break}if(null!==k&&k.hasOwnProperty("method")){var m=this.parseMethod(k.method,c);e.push(j?-m:m)}else for(var n=0;n<g.length;++n){var o=g[n];if(o.hasOwnProperty(i))if("method"===k.type){var p=this.parseMethod(o[i],o);e.push(j?-p:p)}else"number"===k.type&&e.push(j?-o[i]:o[i])}}else e.push(i)}else for(var q=0;q<b.length;++q){var r=b[q];"number"==typeof r?e.push(r):c.hasOwnProperty(r)?e.push(c[r]):"-"===r.charAt(0)&&c.hasOwnProperty(r.slice(1))&&e.push(-c[r.slice(1)])}return d=this.methods[a](e)},this.parseMethod=function(a,b){var c=a.replace(/\s+/g,"");c=c.split(/([\,\(\)])/).clean();for(var d=[[]],e=[],f=0;f<c.length;++f){var g=c[f];if(this.methods.hasOwnProperty(g))e.push(g);else if("("===g)d.push([]);else if(g.isNumeric())d[d.length-1].push(parseFloat(g));else if(")"===g){var h=e.pop(),i=d.pop(),j=this.calculate(h,i,b);d[d.length-1].push(j)}else","!==g&&d[d.length-1].push(g)}var k=2;"number"==typeof this.settings.precision&&(k=this.settings.precision);var l=parseFloat(d.pop()).toFixed(k);return l=isNaN(l)?"":l},this.editFor=function(a){for(var b=this.data.tbody[a],c=this.data.thead.cols,d=this.data.table,e="",f=0;f<c.length;++f){var g=c[f].id,h=c[f].title,i=c[f].type,j=null;if(!c[f].hasOwnProperty("method")&&"method"!==i&&"actionArray"!==i){switch(e+='<div class="form-group row">',e+='<label for="tcEdit_'+g+'" class="control-label col-md-4">'+h+"</label>",e+="number"===i?'<div class="col-md-push-3 col-md-5">':'<div class="col-md-8">',d.pool.hasOwnProperty(g)&&d.pool[g].constructor===Array&&(i="dropdown",j=d.pool[g]),i){case"undefined":case"default":case"string":e+='<input type="text" class="form-control" name="tcEdit_'+g+'" value="'+b[g]+'"/>';break;case"number":var k=Math.pow(10,d.settings.decimals);e+='<input type="number" class="form-control" step="'+(k?1/k:1)+'" name="tcEdit_'+g+'" value="'+b[g]+'"/>';break;case"dropdown":e+='<select class="form-control" name="tcEdit_'+g+'">';for(var l=0;l<j.length;++l){var m=b[g]===j[l]?' selected="selected"':"";e+="<option"+m+">"+j[l]+"</option>"}e+="</select>"}e+="</div></div>"}}return e},this.saveEdit=function(a,b){var c=[],d=!0,e=a.find("input[name^='tcEdit_']");if(e.each(function(){var a=$(this);console.log(this),0==$(this).callProp("checkValidity")?(d=!1,a.addClass("tc_warning")):(console.log(this),a.removeClass("tc_warning"))}),d===!1)return!1;var f,g,h,i,j=a.find("input[name^='tcEdit_']");j.each(function(a,b){f=$(b),g=f.attr("name").slice("tcEdit_".length),h=f.val(),i=f.attr("type"),c.push({key:g,value:h,type:i}),console.log({key:g,value:h})});var k=a.find("select[name^='tcEdit_']");k.each(function(a,b){f=$(b),g=f.attr("name").slice("tcEdit_".length),h=f.val(),c.push({key:g,value:h}),console.log({key:g,value:h})});for(var l={},m=this.data.tbody[b],n=!1,o=0;o<c.length;++o){if(g=c[o].key,h=c[o].value,i=c[o].hasOwnProperty("type")?c[o].type:null,m.hasOwnProperty(g))if("number"==i&&m[g]!==parseFloat(h)){if(l[g]=m[g],h=parseFloat(h),isNaN(h)){var p=a.find("[name^='tcEdit_"+g+"']");p.toggleClass("tc_warning"),n=!0;continue}m[g]=parseFloat(h)}else m[g]!==h&&(l[g]=m[g],m[g]=h);else l[g]=null,m[g]=h;console.log(g+" changed it's value from "+l[g]+" to "+h)}return!n&&($.isEmptyObject(l)||(m.cache=l),console.log(m),console.log(this.data.tbody[b]),console.log("Yay! Will store in "+b),void this.build().activate())},this.addEditLinks=function(){function a(a){var c=a.target.getAttribute("data-tc_row");b.spawnEditModal(c)}var b=this,c=$(this.el).find(".tcAction.edit");c.on("click",a)},this.spawnEditModal=function(a){function b(){return c.saveEdit(e,a)}var c=this,d=$("#EditModal"),e=d.find(".modal-body");e.html(this.editFor(a));var f=d.find("#EditSave");f.off("click").on("click",b),d.modal("show")},this):new TableCreator(a,b)}String.prototype.isNumeric=function(){return!isNaN(parseFloat(this))&&isFinite(this)},Array.prototype.clean=function(){for(var a=0;a<this.length;a++)""===this[a]&&this.splice(a,1);return this};
/*! tablecreator 2016-08-11 */
"use strict";function TableCreator(a,b){return this instanceof TableCreator?(this.ctx=this,this.data=a,this.el=b,this.settings={schemaId:null,instanceId:null,precision:2,saveUrl:null,deleteUrl:null},this.build=function(){return this.buildTable(this.data,this.el),this},this.setSaveUrl=function(a){return this.settings.saveUrl=a,this},this.activate=function(){return null===this.settings.saveUrl&&console.warn("Url to save changes is not set."),null===this.settings.deleteUrl&&console.warn("Url to delete rows is not set."),this.data.hasOwnProperty("table")&&(this.data.table.hasOwnProperty("schemaId")&&(this.settings.schemaId=this.data.table.schemaId),this.data.table.hasOwnProperty("instanceId")&&(this.settings.instanceId=this.data.table.instanceId)),0===$("#EditModal").length&&this.createModal("Edit","Endring","Lukk","Lagre"),this.addEditLinks(),this},this.buildTable=function(a,b){var c="";a.hasOwnProperty("table")&&(c=a.table.hasOwnProperty("class")?a.table["class"]:""),a.hasOwnProperty("table")&&a.table.hasOwnProperty("settings")&&a.table.settings.hasOwnProperty("decimals")&&"number"==typeof a.table.settings.decimals&&(this.settings.precision=a.table.settings.decimals);for(var d='<table class="tc_table '+c+'"><thead>',e=0;e<a.thead.rows.length;++e){var f=a.thead.rows[e];d+="<tr>";for(var g=0;g<f.length;++g){var h=f[g],i=h.hasOwnProperty("colspan")?' colspan="'+h.colspan+'"':"",j=h.hasOwnProperty("title")?h.title:"";d+='<th class="tcTableHeaders" '+i+">"+j+"</th>"}d+="</tr>"}d+="<tr>";for(var k=0;k<a.thead.cols.length;++k){var l=a.thead.cols[k],m=l.hasOwnProperty("title")?l.title:null,n=l.hasOwnProperty("class")?l["class"]:"";d+='<th class="'+n+'">'+m+"</th>"}d+="</tr>",d+="</thead><tbody>";for(var o=0;o<a.tbody.length;++o){var p=a.tbody[o];d+=p.hasOwnProperty("retry")?'<tr class="tcNotSaved">':"<tr>";for(var q=a.thead.cols,r=0;r<q.length;++r){var s=q[r].id,t=p.hasOwnProperty(s)?p[s]:"",u=q[r].hasOwnProperty("class")?q[r]["class"]:"";if(q[r].hasOwnProperty("method")){var v=q[r].method,w=q[r].hasOwnProperty("type")?q[r].type:"",x=this.parseMethod(v,p);x="number"==w?this.formatData(x,"number"):x,d+='<td class="'+w+" "+u+'">'+x+"</td>"}else if(q[r].hasOwnProperty("type"))switch(q[r].type){case"method":t=this.parseMethod(t,p),d+='<td class="'+q[r].type+" "+u+'">'+this.formatData(t,"number")+"</td>";break;case"number":d+='<td class="'+q[r].type+" "+u+'">'+this.formatData(t,"number")+"</td>";break;case"string":case"undefined":d+='<td class="tcLeftAlign '+q[r].type+" "+u+'">'+t+"</td>";break;case"index":d+="<td>"+(o+1)+"</td>";break;case"actionArray":d+='<td class="tcRightAlign '+u+'">';var y=!!p.hasOwnProperty("isSaving")&&p.isSaving;y===!0&&(d+='<i class="fa fa-refresh fa-spin"></i>');var z=q[r].hasOwnProperty("actions")?q[r].actions:null;if(null!==z&&z.constructor===Array)for(var A=0;A<z.length;++A)switch(z[A]){case"retry":p.hasOwnProperty("retry")&&null!==p.retry&&(d+='<span title="Prøv på nytt" class="tcAction retry" data-tc_action="retry" data-tc_row="'+o+'">Prøv på nytt</span>');break;case"undo":p.hasOwnProperty("undo")&&null!==p.undo&&(d+='<span title="Angre" class="tcAction undo" data-tc_action="undo" data-tc_row="'+o+'">angre</span>');break;case"edit":d+='<span title="Rediger" class="tcAction edit" data-tc_action="edit" data-tc_row="'+o+'">rediger</span>'}d+="</td>";break;default:d+='<td class="'+q[r].type+" "+u+'">'+t+"</td>"}else d+='<td class="tcLeftAlign '+u+'"></td>'}d+="</tr>"}if(d+="</tbody>",a.tfoot.hasOwnProperty("cols")&&Array.isArray(a.tfoot.cols)&&a.tfoot.cols.length>0){d+="<tfoot><tr>";for(var B=0;B<a.tfoot.cols.length;++B){var C,D=a.tfoot.cols[B],E="";B<a.thead.cols.length&&(E=a.thead.cols[B].hasOwnProperty("class")?a.thead.cols[B]["class"]:"");var F=D.hasOwnProperty("class")?D["class"]:"";D.hasOwnProperty("title")?d+='<td class="'+E+" "+F+' string">'+D.title+"</td>":D.hasOwnProperty("method")?(C=this.parseMethod(D.method,a),d+='<td class="'+E+" "+F+' number">'+this.formatData(C,"number")+"</td>"):d+='<td class="'+E+'"></td>'}d+="</tfoot></tr>"}d+="</table>",b.innerHTML=d},this.formatData=function(a,b){var c=a;switch(b){case"number":var d=c.toString().split(".");d[0]=d[0].replace(/\B(?=(\d{3})+(?!\d))/g," "),c=d.join(".");var e='<span class="minus">'+c.replace("-","- ")+"</span>";c="-"==c.charAt(0)?e:c}return c},this.methods={sum:function(a){for(var b=0,c=0;c<a.length;++c)b+=parseFloat(a[c]);return b},avg:function(a){for(var b=0,c=0;c<a.length;++c)b+=parseFloat(a[c]);return b/a.length}},this.calculate=function(a,b,c){var d,e=[];if(c.hasOwnProperty("tbody"))for(var f=c.thead.cols,g=c.tbody,h=0;h<b.length;++h){var i=b[h];if("number"!=typeof i){var j=!1;"string"==typeof i&&"-"===i.charAt(0)&&(j=!0,i=i.slice(1));for(var k=null,l=0;l<f.length;++l)if(f[l].id===i){k=f[l];break}if(null!==k&&k.hasOwnProperty("method")){var m=this.parseMethod(k.method,c);e.push(j?-m:m)}else for(var n=0;n<g.length;++n){var o=g[n];if(o.hasOwnProperty(i))if("method"===k.type){var p=this.parseMethod(o[i],o);e.push(j?-p:p)}else"number"===k.type&&e.push(j?-o[i]:o[i])}}else e.push(i)}else for(var q=0;q<b.length;++q){var r=b[q];"number"==typeof r?e.push(r):c.hasOwnProperty(r)?e.push(c[r]):"-"===r.charAt(0)&&c.hasOwnProperty(r.slice(1))&&e.push(-c[r.slice(1)])}return d=this.methods[a](e)},this.parseMethod=function(a,b){var c=a.replace(/\s+/g,"");c=c.split(/([\,\(\)])/).clean();for(var d=[[]],e=[],f=0;f<c.length;++f){var g=c[f];if(this.methods.hasOwnProperty(g))e.push(g);else if("("===g)d.push([]);else if(g.isNumeric())d[d.length-1].push(parseFloat(g));else if(")"===g){var h=e.pop(),i=d.pop(),j=this.calculate(h,i,b);d[d.length-1].push(j)}else","!==g&&d[d.length-1].push(g)}var k=2;"number"==typeof this.settings.precision&&(k=this.settings.precision);var l=parseFloat(d.pop()).toFixed(k);return l=isNaN(l)?"":l},this.addUndoLinks=function(){function a(a){var c=a.target.getAttribute("data-tc_row");b.spawnUndoModal(c)}var b=this,c=$(this.el).find(".tcAction.undo");c.on("click",a)},this.spawnUndoModal=function(a,b){function c(){d.undoAction(a)}void 0===b&&(b=null);var d=this,e=$("#tcUndoModal"),f=e.find(".modal-body");f.html("<p>Angre og gå eit steg tilbake?</p>");var g=e.find("#tcUndoModal_Save");g.off("click").on("click",c),e.modal("show")},this.undoAction=function(){alert("Angre!")},this.createModal=function(a,b,c,d){var e=$('<div class="modal-header">'),f=$('<div class="modal-body">'),g=$('<div class="modal-footer">');e.append($('<button type="button" class="close" data-dismiss="modal" aria-label="Lukk"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">'+b+"</h4>")),g.append($('<button type="button" class="btn btn-default" data-dismiss="modal">'+c+'</button><button type="button" class="btn btn-primary" id="'+a+'Save">'+d+"</button>"));var h=$('<div id="'+a+'Modal" class="modal face" tabindex="1" role="dialog">').append($('<div class="modal-dialog">').append($('<div class="modal-content">').append(e).append(f).append(g)));$(this.el).after(h)},this.addEditLinks=function(){function a(a){var c=a.target.getAttribute("data-tc_row");b.spawnEditModal(c)}var b=this,c=$(this.el).find(".tcAction.edit");c.on("click",a)},this.spawnEditModal=function(a,b){function c(){return d.saveEdit(f,a)}void 0===b&&(b=null);var d=this,e=$("#EditModal"),f=e.find(".modal-body");if(f.data("rowIdx",a),f.html(this.editFor(a)),null!==b){var g=$('<div class="panel panel-warning">');g.append('<div class="panel-heading">Feil</div>');var h=$('<div class="panel-body"></div>');g.append(h);for(var i=0;i<b.length;++i){var j=$("<li>");j.html(b[i]),h.append(j)}f.prepend(g)}var k=e.find("#EditSave");k.off("click").on("click",c),e.modal("show")},this.editFor=function(a){for(var b=this.data.tbody[a],c=this.data.thead.cols,d=this.data.table,e="",f=0;f<c.length;++f){var g=c[f].id,h=c[f].title,i=c[f].type,j=null;if(!c[f].hasOwnProperty("method")&&"method"!==i&&"actionArray"!==i){switch(e+='<div class="form-group row">',e+='<label for="tcEdit_'+g+'" class="control-label col-md-4">'+h+"</label>",e+="number"===i?'<div class="col-md-push-3 col-md-5">':'<div class="col-md-8">',d.pool.hasOwnProperty(g)&&d.pool[g].constructor===Array&&(i="dropdown",j=d.pool[g]),i){case"undefined":case"default":case"string":e+='<input type="text" class="form-control" name="tcEdit_'+g+'" value="'+b[g]+'"/>';break;case"number":var k=Math.pow(10,d.settings.decimals);e+='<input type="number" class="form-control" step="'+(k?1/k:1)+'" name="tcEdit_'+g+'" value="'+b[g]+'"/>';break;case"dropdown":e+='<select class="form-control" name="tcEdit_'+g+'">';for(var l=0;l<j.length;++l){var m=b[g]===j[l]?' selected="selected"':"";e+="<option"+m+">"+j[l]+"</option>"}e+="</select>"}e+="</div></div>"}}return e},this.saveEdit=function(a,b){function c(a,c,d){e.rowUndo(b);var f=$("#EditModal"),g=$("#EditModal .errorDiv");switch(0===g.length&&(g=$('<div class="errorDiv alert alert-danger"></div>'),f.find(".modal-body").prepend(g)),a.status){case 404:g.html("<p>Ikke lagret:</p><li>Finner ikke lagringsplass (feil 404).</li>");break;default:g.html("<p>Lagring ikke mulig (feil "+a.status+").</p>")}console.log(p.undo),f.modal("show")}function d(a,c,d){if(a.Success=!0,a.Message="Message",a.Errors=["Message1","Message2","Message3"],p.isSaving=!1,a.Success===!1){e.removeLastUndo(b);var f=a.Errors&&a.Errors.constructor===Array?a.Errors:null;return e.setEditModalError(a.Message,f),e.build().activate(),void console.log(p.undo)}e.build().activate(),console.log(p.undo),$("#EditModal").modal("hide")}var e=this,f=[],g=!0,h=a.find("input[name^='tcEdit_']");if(h.each(function(){var a=$(this);console.log(this),$(this).callProp("checkValidity")===!1?(g=!1,a.addClass("tc_warning")):(console.log(this),a.removeClass("tc_warning"))}),g===!1)return!1;var i,j,k,l,m=a.find("input[name^='tcEdit_']");m.each(function(a,b){i=$(b),j=i.attr("name").slice("tcEdit_".length),k=i.val(),l=i.attr("type"),f.push({key:j,value:k,type:l}),console.log({key:j,value:k})});var n=a.find("select[name^='tcEdit_']");n.each(function(a,b){i=$(b),j=i.attr("name").slice("tcEdit_".length),k=i.val(),f.push({key:j,value:k}),console.log({key:j,value:k})});for(var o={},p=this.data.tbody[b],q=!1,r=0;r<f.length;++r){if(j=f[r].key,k=f[r].value,l=f[r].hasOwnProperty("type")?f[r].type:null,p.hasOwnProperty(j))if("number"==l&&parseFloat(p[j])!==parseFloat(k)){if(o[j]=p[j],k=parseFloat(k),isNaN(k)){var s=a.find("[name^='tcEdit_"+j+"']");s.toggleClass("tc_warning"),q=!0;continue}p[j]=parseFloat(k)}else"number"!=l&&p[j]!==k&&(o[j]=p[j],p[j]=k);else o[j]=null,p[j]=k;console.log(j+" changed it's value from "+o[j]+" to "+k)}if(q)return!1;$.isEmptyObject(o)||(p.isSaving=!0),p.hasOwnProperty("undo")||(p.undo=null);var t=p.undo,u={};for(var v in o)o.hasOwnProperty(v)&&(u[v]=o[v]);u.undo=t,p.undo=u,console.log(p),console.log(this.data.tbody[b]),console.log("Yay! Will store in "+b),this.build().activate();var w={SchemaId:this.settings.schemaId,InstanceId:this.settings.instanceId,RowId:b,Data:JSON.stringify(p)};$.ajax({type:"POST",url:this.settings.saveUrl,dataType:"json",data:w,success:d,error:c})},this.setEditModalError=function(a,b){var c=$("#EditModal"),d=c.find(".errorDiv");if(0===d.length&&(d=$('<div class="errorDiv alert alert-danger"></div>'),c.find(".modal-body").prepend(d)),d.html("<p>"+a+"</p>"),b&&b.constructor===Array)for(var e=0;e<b.length;++e)d.append($("<li>"+b[e]+"</li>"))},this.removeLastUndo=function(a){var b=this.data.tbody[a];if(b.hasOwnProperty("undo")&&null!==b.undo){var c=b.undo,d=b.undo.undo;for(var e in c)c.hasOwnProperty(e)&&"undo"!==e&&(b.property=c.property);b.undo=d}},this):new TableCreator(a,b)}String.prototype.isNumeric=function(){return!isNaN(parseFloat(this))&&isFinite(this)},Array.prototype.clean=function(){for(var a=0;a<this.length;a++)""===this[a]&&this.splice(a,1);return this};